<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Android Security Toolkit"><meta name=author content=Kevlar><link href=https://kevlar-kt.github.io/kevlar/pages/modules/integrity/implementation/ rel=canonical><link rel=icon href=../../../../assets/images/shield_light.png><meta name=generator content="mkdocs-1.4.0, mkdocs-material-8.5.10"><title>Implementation - Kevlar</title><link rel=stylesheet href=../../../../assets/stylesheets/main.975780f9.min.css><link rel=stylesheet href=../../../../assets/stylesheets/palette.2505c338.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../../assets/css/app.css><link rel=stylesheet href=../../../../assets/css/extra.css><script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=cyan data-md-color-accent=orange> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#implementation class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../../.. title=Kevlar class="md-header__button md-logo" aria-label=Kevlar data-md-component=logo> <img src=../../../../assets/images/shield_light.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Kevlar </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Implementation </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=cyan data-md-color-accent=orange aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=cyan data-md-color-accent=orange aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/kevlar-kt/kevlar title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> kevlar </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../.. class=md-tabs__link> Index </a> </li> <li class=md-tabs__item> <a href=../../antipiracy/antipiracy/ class=md-tabs__link> Antipiracy </a> </li> <li class=md-tabs__item> <a href=../../rooting/rooting/ class=md-tabs__link> Rooting </a> </li> <li class=md-tabs__item> <a href=../integrity/ class="md-tabs__link md-tabs__link--active"> Integrity </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../.. title=Kevlar class="md-nav__button md-logo" aria-label=Kevlar data-md-component=logo> <img src=../../../../assets/images/shield_light.png alt=logo> </a> Kevlar </label> <div class=md-nav__source> <a href=https://github.com/kevlar-kt/kevlar title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> kevlar </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1> <div class="md-nav__link md-nav__link--index "> <a href=../../../..>Index</a> <label for=__nav_1> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=Index data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Index </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../overview/dependencies_integration/ class=md-nav__link> Dependencies & Integration </a> </li> <li class=md-nav__item> <a href=../../../overview/anatomy_of_attacks/ class=md-nav__link> Anatomy of an Attack </a> </li> <li class=md-nav__item> <a href=../../../overview/philosophy/ class=md-nav__link> Philosophy </a> </li> <li class=md-nav__item> <a href=../../../overview/attitude/ class=md-nav__link> Attitude </a> </li> <li class=md-nav__item> <a href=../../../overview/material/ class=md-nav__link> Technical Material </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Antipiracy <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Antipiracy data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Antipiracy </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../antipiracy/antipiracy/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../antipiracy/implementation/ class=md-nav__link> Implementation </a> </li> <li class=md-nav__item> <a href=../../antipiracy/detection/ class=md-nav__link> Detection </a> </li> <li class=md-nav__item> <a href=../../antipiracy/database/ class=md-nav__link> Database </a> </li> <li class=md-nav__item> <a href=../../antipiracy/privacy/ class=md-nav__link> Privacy & Permissions </a> </li> <li class=md-nav__item> <a href=../../antipiracy/tradeoffs/ class=md-nav__link> Tradeoffs </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> Rooting <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Rooting data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Rooting </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../rooting/rooting/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../rooting/implementation/ class=md-nav__link> Implementation </a> </li> <li class=md-nav__item> <a href=../../rooting/internals/ class=md-nav__link> Internals </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4> Integrity <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Integrity data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Integrity </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../integrity/ class=md-nav__link> Overview </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Implementation <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Implementation </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#dependency class=md-nav__link> Dependency </a> </li> <li class=md-nav__item> <a href=#hardcoded-metadata class=md-nav__link> Hardcoded metadata </a> <nav class=md-nav aria-label="Hardcoded metadata"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#understanding-which-metadata-you-need class=md-nav__link> Understanding which metadata you need </a> </li> <li class=md-nav__item> <a href=#finding-metadata class=md-nav__link> Finding metadata </a> <nav class=md-nav aria-label="Finding metadata"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#direct-application-extraction class=md-nav__link> Direct application extraction </a> </li> <li class=md-nav__item> <a href=#android-studio-extraction class=md-nav__link> Android studio extraction </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#obfuscating-metadata class=md-nav__link> Obfuscating metadata </a> <nav class=md-nav aria-label="Obfuscating metadata"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#no-obfuscation-not-recommended class=md-nav__link> No obfuscation (not recommended) </a> </li> <li class=md-nav__item> <a href=#base64-obfuscation class=md-nav__link> Base64 obfuscation </a> </li> <li class=md-nav__item> <a href=#encryption-base64 class=md-nav__link> Encryption (+base64) </a> </li> <li class=md-nav__item> <a href=#hashing class=md-nav__link> Hashing </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#initialization-attestations class=md-nav__link> Initialization &amp; Attestations </a> </li> <li class=md-nav__item> <a href=#in-place class=md-nav__link> In-Place </a> </li> <li class=md-nav__item> <a href=#viewmodel-repository-sharedflow-di-with-hilt class=md-nav__link> ViewModel + Repository + SharedFlow + DI with Hilt </a> <nav class=md-nav aria-label="ViewModel + Repository + SharedFlow + DI with Hilt"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#activity class=md-nav__link> Activity: </a> </li> <li class=md-nav__item> <a href=#view-model class=md-nav__link> View model: </a> </li> <li class=md-nav__item> <a href=#repository class=md-nav__link> Repository </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../hardcoding/ class=md-nav__link> Hardcoding </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#dependency class=md-nav__link> Dependency </a> </li> <li class=md-nav__item> <a href=#hardcoded-metadata class=md-nav__link> Hardcoded metadata </a> <nav class=md-nav aria-label="Hardcoded metadata"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#understanding-which-metadata-you-need class=md-nav__link> Understanding which metadata you need </a> </li> <li class=md-nav__item> <a href=#finding-metadata class=md-nav__link> Finding metadata </a> <nav class=md-nav aria-label="Finding metadata"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#direct-application-extraction class=md-nav__link> Direct application extraction </a> </li> <li class=md-nav__item> <a href=#android-studio-extraction class=md-nav__link> Android studio extraction </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#obfuscating-metadata class=md-nav__link> Obfuscating metadata </a> <nav class=md-nav aria-label="Obfuscating metadata"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#no-obfuscation-not-recommended class=md-nav__link> No obfuscation (not recommended) </a> </li> <li class=md-nav__item> <a href=#base64-obfuscation class=md-nav__link> Base64 obfuscation </a> </li> <li class=md-nav__item> <a href=#encryption-base64 class=md-nav__link> Encryption (+base64) </a> </li> <li class=md-nav__item> <a href=#hashing class=md-nav__link> Hashing </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#initialization-attestations class=md-nav__link> Initialization &amp; Attestations </a> </li> <li class=md-nav__item> <a href=#in-place class=md-nav__link> In-Place </a> </li> <li class=md-nav__item> <a href=#viewmodel-repository-sharedflow-di-with-hilt class=md-nav__link> ViewModel + Repository + SharedFlow + DI with Hilt </a> <nav class=md-nav aria-label="ViewModel + Repository + SharedFlow + DI with Hilt"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#activity class=md-nav__link> Activity: </a> </li> <li class=md-nav__item> <a href=#view-model class=md-nav__link> View model: </a> </li> <li class=md-nav__item> <a href=#repository class=md-nav__link> Repository </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=implementation>Implementation<a class=headerlink href=#implementation title="Permanent link">&para;</a></h1> <p>Implementing <code>integrity</code> requires, on top of a <code>KevlarAntipiracy</code> and the attestation infrastructure, a bit of information about your application's metadata, which will be hardcoded inside it.</p> <p>Hardcoded data is necessary to provide kevlar a <strong>truth value</strong> (essentially, that should be the description of all the scenarios that the application is allowed to run in) to match the runtime values of your binary (which may have been tampered or altered by an attacker) against.</p> <p>That's because, if done well, we can detect almost every kind of attack/tampering attempt through checking various APK metadata, such as the package name, the signature, the installer and debug flags.</p> <p>The obfuscation is necessary because we need to conceal the truth values, since they will be looked for by the attacker (software or human), and make it as hard as possible to automatically find and patch them.</p> <p>A working example for the integrity module can be found in the github repository under the <code>:showcase</code> module.</p> <h2 id=dependency>Dependency<a class=headerlink href=#dependency title="Permanent link">&para;</a></h2> <details class=gradle open=open> <summary>Gradle</summary> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=n>dependencies</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=w>    </span><span class=n>implementation</span><span class=w> </span><span class=s>&quot;io.github.kevlar-kt:integrity:1.0.0&quot;</span><span class=w></span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=p>}</span><span class=w></span>
</code></pre></div> </details> <details class=gradle> <summary>Kotlin DSL</summary> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=n>dependencies</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=w>    </span><span class=n>implementation</span><span class=p>(</span><span class=s>&quot;io.github.kevlar-kt:integrity:1.0.0&quot;</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=p>}</span><span class=w></span>
</code></pre></div> </details> <details class=gradle> <summary>Maven</summary> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=nt>&lt;dependency&gt;</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>    <span class=nt>&lt;groupId&gt;</span>io.github.kevlar-kt<span class=nt>&lt;/groupId&gt;</span>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a>    <span class=nt>&lt;artifactId&gt;</span>integrity<span class=nt>&lt;/artifactId&gt;</span>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>    <span class=nt>&lt;version&gt;</span>1.0.0<span class=nt>&lt;/version&gt;</span>
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>    <span class=nt>&lt;type&gt;</span>pom<span class=nt>&lt;/type&gt;</span>
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=nt>&lt;/dependency&gt;</span>
</code></pre></div> </details> <h2 id=hardcoded-metadata>Hardcoded metadata<a class=headerlink href=#hardcoded-metadata title="Permanent link">&para;</a></h2> <h3 id=understanding-which-metadata-you-need>Understanding which metadata you need<a class=headerlink href=#understanding-which-metadata-you-need title="Permanent link">&para;</a></h3> <p>The first step is choosing which checks to run, and thus which data to provide kevlar.</p> <p>The good news is that they all are stable metadata. This means that once you make the effort of searching the right strings and implementing everything, you are ideally good to go forever.</p> <p>Kevlar has 4 kinds of checks: a package name check, a signature check, an installer check and a debug check.</p> <table> <thead> <tr> <th>Check Type</th> <th>Required parameters</th> <th>Parameter type</th> </tr> </thead> <tbody> <tr> <td>Package Name</td> <td>package name</td> <td><code>String</code></td> </tr> <tr> <td>Signature Check</td> <td>app signature</td> <td><code>String</code> (base64-encoded)</td> </tr> <tr> <td>Installer Check</td> <td>N/A</td> <td>N/A</td> </tr> <tr> <td>Debug Check</td> <td>N/A</td> <td>N/A</td> </tr> </tbody> </table> <p>The hardcoded metadata you need to find is the following:</p> <ul> <li>Your application <strong>package name</strong>: Will check that the running binary's package name matches the hardcoded package name;</li> <li>Your application <strong>signature</strong>: Will check that the running binary's signature is the same as the hardcoded signature.</li> </ul> <p>Additionally, you should consider enabling the other two kinds of checks:</p> <ul> <li><strong>Debug checks</strong>: Is enabled, kevlar autonomously checks for debug flags and bits in your binary;</li> <li><strong>Installer checks</strong>: If enabled, kevlar will report any application which has not been installed through an allowed installer (by default it only supports the Play Store, but you can add custom stores if you distribute your software elsewhere).</li> </ul> <p>Once you choose which kind of checks you want to run, you get the required metadata</p> <div class=highlight><span class=filename>hardcoded_metadata.kt</span><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=c1>// Holds the package name</span><span class=w></span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>packageNameData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HardcodedPackageName</span><span class=p>(</span><span class=w></span>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=w>    </span><span class=n>packageName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;com.kevlar.showcase&quot;</span><span class=w></span>
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=p>)</span><span class=w></span>
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=c1>// Holds the signature</span><span class=w></span>
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>signatureData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HardcodedBase64EncodedSignature</span><span class=p>(</span><span class=w></span>
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=w>    </span><span class=n>base64EncodedSignature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;J+nqXLfuIO8B2AmhkMYHGE4jDyw=&quot;</span><span class=w></span>
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=p>)</span><span class=w></span>
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>
<a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=c1>// Combines all the metadata and configuration</span><span class=w></span>
<a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>integrity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>KevlarIntegrity</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=w>    </span><span class=n>checks</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=w>        </span><span class=n>packageName</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=w>            </span><span class=n>hardcodedPackageName</span><span class=p>(</span><span class=n>packageNameData</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a><span class=w>        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a>
<a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a><span class=w>        </span><span class=n>signature</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a><span class=w>            </span><span class=n>hardcodedSignatures</span><span class=p>(</span><span class=n>signatureData</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a><span class=w>        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a>
<a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a><span class=w>        </span><span class=n>installer</span><span class=p>()</span><span class=w></span>
<a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a><span class=w>        </span><span class=n>debug</span><span class=p>()</span><span class=w></span>
<a id=__codelineno-3-24 name=__codelineno-3-24 href=#__codelineno-3-24></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-3-25 name=__codelineno-3-25 href=#__codelineno-3-25></a><span class=p>}</span><span class=w></span>
<a id=__codelineno-3-26 name=__codelineno-3-26 href=#__codelineno-3-26></a>
<a id=__codelineno-3-27 name=__codelineno-3-27 href=#__codelineno-3-27></a><span class=c1>// Runs the checks on the current executing app</span><span class=w></span>
<a id=__codelineno-3-28 name=__codelineno-3-28 href=#__codelineno-3-28></a><span class=n>integrity</span><span class=p>.</span><span class=na>attestate</span><span class=p>(</span><span class=n>context</span><span class=p>)</span><span class=w></span>
</code></pre></div> <div class="admonition fail"> <p class=admonition-title>Do not</p> <p>Maybe, just maybe, you may be tempted to so something like this:</p> <div class=highlight><span class=filename>VERY_BAD_hardcoded_metadata.kt</span><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>notAtAllHardcodedMetadata</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HardcodedMetadata</span><span class=p>(</span><span class=w></span>
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=w>    </span><span class=n>packageName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>context</span><span class=p>.</span><span class=na>getPackageName</span><span class=p>(),</span><span class=w></span>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=w>    </span><span class=n>signature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getRuntimeSignature</span><span class=p>()</span><span class=w></span>
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=p>)</span><span class=w></span>
</code></pre></div> <p>The sole purpose of <code>HardcodedMetadata</code> is <strong><a href=https://en.wikipedia.org/wiki/Hard_coding>hardcoding</a></strong> truth values inside your app, which don't depend on the context or application, <strong>which may have been tampered with</strong>. This snippet single handedly kills the whole library (because kevlar will check that the (supposedly) hardcoded package name, in this case <code>context.getPackageName()</code>, matches the runtime package name, which is always true since it is gathered via <code>context.getPackageName()</code> too) and is like shooting yourself in the foot with a cannon. Don't. </p> </div> <h3 id=finding-metadata>Finding metadata<a class=headerlink href=#finding-metadata title="Permanent link">&para;</a></h3> <p>Finding the package name is easy, since you are the one choosing it for your application.</p> <p>For the signature, it's not so straightforward to extract because it depends on your keystore. You have two different ways to get your keystore signature. In the examples we will find the debug signature, but you need to find the signature of the keystore you use to sign your application when publishing on google play.</p> <h4 id=direct-application-extraction>Direct application extraction<a class=headerlink href=#direct-application-extraction title="Permanent link">&para;</a></h4> <p>The most practical way to read your keystore it is to put the following line of code in your app, to then sign the application with the key you are interested in acquiring the signature string of, and run it.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=c1>// This returns the signature of the current running application.</span><span class=w></span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=kd>val</span><span class=w> </span><span class=nv>signature</span><span class=p>:</span><span class=w> </span><span class=kt>String</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>KevlarIntegrity</span><span class=p>.</span><span class=na>obtainCurrentAppSignature</span><span class=p>(</span><span class=n>context</span><span class=p>)</span><span class=w></span>
</code></pre></div> <p>This will output the current app signature. That's the reference string you need to give to kevlar (which will extract the runtime signature of your app and match it against that string).</p> <div class="admonition example"> <p class=admonition-title>Android debug signature</p> <p>Every android application is signed with some key. When an application is signed as "debug", it simply means that it is signed with a special key, which is known to be the debug key.</p> <p>That key has always signature <code>J+nqXLfuIO8B2AmhkMYHGE4jDyw=</code></p> </div> <div class="admonition warning"> <p class=admonition-title>Signature extraction &amp; Google Play App Signing API</p> <p>If you are using Google Play App Signing, the key you sign your application with is not the one your app is distributed with (See the <a href=https://developer.android.com/studio/publish/app-signing>official docs</a> regarding the matter, and a relevant <a href=https://github.com/kevlar-kt/kevlar/issues/1>issue</a> in kevlar).</p> <p>In this case the easiest way to get your actual signature would be to upload a dummy version of your app (which logs the runtime signature) through google play store, let the backend process and sign it, download it (through the archive manager on the play console), install &amp; run it locally on an emulator/device, and save the runtime signature. Once you have done this (quite tedious) procedure, you have your signature and can pass it to kevlar.</p> </div> <h4 id=android-studio-extraction>Android studio extraction<a class=headerlink href=#android-studio-extraction title="Permanent link">&para;</a></h4> <p>Running <code>./gradlew signingReport</code> will spit out all the details for all the different keystores in your project.</p> <p>The signature we are interested in is the SHA-1 entry. In this case, <code>27:E9:EA:5C:B7:EE:20:EF:01:D8:09:A1:90:C6:07:18:4E:23:0F:2C</code>.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>&gt; Task :showcase:signingReport
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>Variant: debug
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>Config: debug
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>Store: /Users/cioccarellia/.android/debug.keystore
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>Alias: AndroidDebugKey
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>MD5: 1B:AF:39:46:4E:13:83:F3:45:E9:0A:5A:53:64:9C:CB
<a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=hll>SHA1: 27:E9:EA:5C:B7:EE:20:EF:01:D8:09:A1:90:C6:07:18:4E:23:0F:2C
</span><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>SHA-256: 36:C8:C0:A1:8A:DD:6D:0E:34:F9:6E:7E:98:DC:1F:89:08:BC:CD:2E:EF:88:ED:45:DF:79:85:D2:39:BD:E1:54
<a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a>Valid until: Tuesday, June 25, 2052
<a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a>----------
<a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a>Variant: release
<a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a>Config: null
<a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a>Store: null
<a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a>Alias: null
<a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a>----------
</code></pre></div> <p>We then have to convert it in a string form (like that we have the raw hex bytes, we want a base64 encoding of the binary signature). In this case the conversion (you can use online tools to do this) yields <code>J+nqXLfuIO8B2AmhkMYHGE4jDyw=</code>.</p> <div class="admonition fail"> <p class=admonition-title>Play Signing</p> <p>Since we don't have access to the keystore file if we use Play Signing, this method is not viable in that case, and you have to resort to uploading a dummy version of the app to have it signed and spit out the signature.</p> </div> <h2 id=obfuscating-metadata>Obfuscating metadata<a class=headerlink href=#obfuscating-metadata title="Permanent link">&para;</a></h2> <p>The second step (optional but recommended) is obfuscating the metadata you just gathered, so that it is <strong>saved</strong> in an obfuscated form (in your bytecode, so that automatic tools / unskilled attackers can't easily find it), but passed to kevlar deobfuscated (so that we have the original truth values at run time).</p> <p>This means that we ship with out app the obfuscated data and the way to convert that obfuscated data back to plaintext to feed kevlar.</p> <p>There are a few different ways to do it, all of them are fully implemented in the <code>:showcase</code> module:</p> <h3 id=no-obfuscation-not-recommended>No obfuscation (not recommended)<a class=headerlink href=#no-obfuscation-not-recommended title="Permanent link">&para;</a></h3> <p>In this case you just save the values as they are, and pass them in <code>HardcodedMetadata</code></p> <div class=highlight><span class=filename>unobfuscated_hardcoded_metadata.kt</span><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=kd>private</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>packageName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HardcodedPackageName</span><span class=p>(</span><span class=s>&quot;com.kevlar.showcase&quot;</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=kd>private</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>signature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HardcodedBase64EncodedSignature</span><span class=p>(</span><span class=s>&quot;J+nqXLfuIO8B2AmhkMYHGE4jDyw=&quot;</span><span class=p>)</span><span class=w></span>
</code></pre></div> <details class=bug> <summary>Bytecode</summary> <p>The produced kotlin bytecode clearly exposes the raw values:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-8-1> 1</a></span>
<span class=normal><a href=#__codelineno-8-2> 2</a></span>
<span class=normal><a href=#__codelineno-8-3> 3</a></span>
<span class=normal><a href=#__codelineno-8-4> 4</a></span>
<span class=normal><a href=#__codelineno-8-5> 5</a></span>
<span class=normal><a href=#__codelineno-8-6> 6</a></span>
<span class=normal><a href=#__codelineno-8-7> 7</a></span>
<span class=normal><a href=#__codelineno-8-8> 8</a></span>
<span class=normal><a href=#__codelineno-8-9> 9</a></span>
<span class=normal><a href=#__codelineno-8-10>10</a></span>
<span class=normal><a href=#__codelineno-8-11>11</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1></a>L1
<a id=__codelineno-8-2 name=__codelineno-8-2></a> ALOAD 0
<a id=__codelineno-8-3 name=__codelineno-8-3></a> NEW com/kevlar/integrity/model/HardcodedMetadata
<a id=__codelineno-8-4 name=__codelineno-8-4></a> DUP
<a id=__codelineno-8-5 name=__codelineno-8-5></a>L2
<a id=__codelineno-8-6 name=__codelineno-8-6></a><span class=hll> LDC &quot;com.kevlar.showcase&quot;
</span><a id=__codelineno-8-7 name=__codelineno-8-7></a>L3
<a id=__codelineno-8-8 name=__codelineno-8-8></a><span class=hll> LDC &quot;J+nqXLfuIO8B2AmhkMYHGE4jDyw=&quot;
</span><a id=__codelineno-8-9 name=__codelineno-8-9></a>L4
<a id=__codelineno-8-10 name=__codelineno-8-10></a> INVOKESPECIAL com/kevlar/integrity/model/HardcodedMetadata.&lt;init&gt; (Ljava/lang/String;Ljava/lang/String;)V
<a id=__codelineno-8-11 name=__codelineno-8-11></a> PUTFIELD com/kevlar/showcase/data/repo/IntegrityRepository.hardcodedMetadata : Lcom/kevlar/integrity/model/HardcodedMetadata;
</code></pre></div></td></tr></table></div> </details> <h3 id=base64-obfuscation>Base64 obfuscation<a class=headerlink href=#base64-obfuscation title="Permanent link">&para;</a></h3> <p>You store the package name and signature values as Base64-encoded byte arrays, and they go through the <code>Base64.decode()</code> function when creating <code>HardcodedMetadata</code>.</p> <div class=highlight><span class=filename>base64_obfuscated_hardcoded_metadata.kt</span><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>packageName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;&quot;&quot;Y29tLmtldmxhci5zaG93Y2FzZQ==&quot;&quot;&quot;</span><span class=p>.</span><span class=na>toByteArray</span><span class=p>()</span><span class=w></span>
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>signature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;&quot;&quot;SitucVhMZnVJTzhCMkFtaGtNWUhHRTRqRHl3PQ==&quot;&quot;&quot;</span><span class=p>.</span><span class=na>toByteArray</span><span class=p>()</span><span class=w></span>
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>
<a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>
<a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>base64ObfuscatedHardcodedPackageName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HardcodedPackageName</span><span class=p>(</span><span class=w></span>
<a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=w>    </span><span class=n>packageName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Base64</span><span class=p>.</span><span class=na>decode</span><span class=p>(</span><span class=n>base64PackageName</span><span class=p>,</span><span class=w> </span><span class=n>Base64</span><span class=p>.</span><span class=na>DEFAULT</span><span class=p>).</span><span class=na>toString</span><span class=p>(</span><span class=n>Charsets</span><span class=p>.</span><span class=na>UTF_8</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=p>)</span><span class=w></span>
<a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a>
<a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>base64ObfuscatedHardcodedSignature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HardcodedBase64EncodedSignature</span><span class=p>(</span><span class=w></span>
<a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=w>    </span><span class=n>Base64</span><span class=p>.</span><span class=na>decode</span><span class=p>(</span><span class=n>base64Signature</span><span class=p>,</span><span class=w> </span><span class=n>Base64</span><span class=p>.</span><span class=na>DEFAULT</span><span class=p>).</span><span class=na>toString</span><span class=p>(</span><span class=n>Charsets</span><span class=p>.</span><span class=na>UTF_8</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a><span class=p>)</span><span class=w></span>
</code></pre></div> <p>Where <code>Y29tLmtldmxhci5zaG93Y2FzZQ==</code> is the base64 encoding of <code>com.kevlar.showcase</code>, and <code>SitucVhMZnVJTzhCMkFtaGtNWUhHRTRqRHl3PQ==</code> of <code>J+nqXLfuIO8B2AmhkMYHGE4jDyw=</code> (the signature).</p> <p>You can look them up <a href=https://www.base64encode.org>online</a>, grab them from your app or use <code>openssl base64</code> in the terminal.</p> <div class="admonition info"> <p class=admonition-title>Base64 flags &amp; charset</p> <p>The flag field and charset don't necessarily need to be <code>Base64.DEFAULT</code> and <code>UTF_8</code>. Even though they are the most popular, you may choose something else if you prefer, as long as you preserve consistency.</p> </div> <details class=bug> <summary>Bytecode</summary> <p>Here the metadata is hidden and not targetable with basic find-and-replace techniques</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-10-1> 1</a></span>
<span class=normal><a href=#__codelineno-10-2> 2</a></span>
<span class=normal><a href=#__codelineno-10-3> 3</a></span>
<span class=normal><a href=#__codelineno-10-4> 4</a></span>
<span class=normal><a href=#__codelineno-10-5> 5</a></span>
<span class=normal><a href=#__codelineno-10-6> 6</a></span>
<span class=normal><a href=#__codelineno-10-7> 7</a></span>
<span class=normal><a href=#__codelineno-10-8> 8</a></span>
<span class=normal><a href=#__codelineno-10-9> 9</a></span>
<span class=normal><a href=#__codelineno-10-10>10</a></span>
<span class=normal><a href=#__codelineno-10-11>11</a></span>
<span class=normal><a href=#__codelineno-10-12>12</a></span>
<span class=normal><a href=#__codelineno-10-13>13</a></span>
<span class=normal><a href=#__codelineno-10-14>14</a></span>
<span class=normal><a href=#__codelineno-10-15>15</a></span>
<span class=normal><a href=#__codelineno-10-16>16</a></span>
<span class=normal><a href=#__codelineno-10-17>17</a></span>
<span class=normal><a href=#__codelineno-10-18>18</a></span>
<span class=normal><a href=#__codelineno-10-19>19</a></span>
<span class=normal><a href=#__codelineno-10-20>20</a></span>
<span class=normal><a href=#__codelineno-10-21>21</a></span>
<span class=normal><a href=#__codelineno-10-22>22</a></span>
<span class=normal><a href=#__codelineno-10-23>23</a></span>
<span class=normal><a href=#__codelineno-10-24>24</a></span>
<span class=normal><a href=#__codelineno-10-25>25</a></span>
<span class=normal><a href=#__codelineno-10-26>26</a></span>
<span class=normal><a href=#__codelineno-10-27>27</a></span>
<span class=normal><a href=#__codelineno-10-28>28</a></span>
<span class=normal><a href=#__codelineno-10-29>29</a></span>
<span class=normal><a href=#__codelineno-10-30>30</a></span>
<span class=normal><a href=#__codelineno-10-31>31</a></span>
<span class=normal><a href=#__codelineno-10-32>32</a></span>
<span class=normal><a href=#__codelineno-10-33>33</a></span>
<span class=normal><a href=#__codelineno-10-34>34</a></span>
<span class=normal><a href=#__codelineno-10-35>35</a></span>
<span class=normal><a href=#__codelineno-10-36>36</a></span>
<span class=normal><a href=#__codelineno-10-37>37</a></span>
<span class=normal><a href=#__codelineno-10-38>38</a></span>
<span class=normal><a href=#__codelineno-10-39>39</a></span>
<span class=normal><a href=#__codelineno-10-40>40</a></span>
<span class=normal><a href=#__codelineno-10-41>41</a></span>
<span class=normal><a href=#__codelineno-10-42>42</a></span>
<span class=normal><a href=#__codelineno-10-43>43</a></span>
<span class=normal><a href=#__codelineno-10-44>44</a></span>
<span class=normal><a href=#__codelineno-10-45>45</a></span>
<span class=normal><a href=#__codelineno-10-46>46</a></span>
<span class=normal><a href=#__codelineno-10-47>47</a></span>
<span class=normal><a href=#__codelineno-10-48>48</a></span>
<span class=normal><a href=#__codelineno-10-49>49</a></span>
<span class=normal><a href=#__codelineno-10-50>50</a></span>
<span class=normal><a href=#__codelineno-10-51>51</a></span>
<span class=normal><a href=#__codelineno-10-52>52</a></span>
<span class=normal><a href=#__codelineno-10-53>53</a></span>
<span class=normal><a href=#__codelineno-10-54>54</a></span>
<span class=normal><a href=#__codelineno-10-55>55</a></span>
<span class=normal><a href=#__codelineno-10-56>56</a></span>
<span class=normal><a href=#__codelineno-10-57>57</a></span>
<span class=normal><a href=#__codelineno-10-58>58</a></span>
<span class=normal><a href=#__codelineno-10-59>59</a></span>
<span class=normal><a href=#__codelineno-10-60>60</a></span>
<span class=normal><a href=#__codelineno-10-61>61</a></span>
<span class=normal><a href=#__codelineno-10-62>62</a></span>
<span class=normal><a href=#__codelineno-10-63>63</a></span>
<span class=normal><a href=#__codelineno-10-64>64</a></span>
<span class=normal><a href=#__codelineno-10-65>65</a></span>
<span class=normal><a href=#__codelineno-10-66>66</a></span>
<span class=normal><a href=#__codelineno-10-67>67</a></span>
<span class=normal><a href=#__codelineno-10-68>68</a></span>
<span class=normal><a href=#__codelineno-10-69>69</a></span>
<span class=normal><a href=#__codelineno-10-70>70</a></span>
<span class=normal><a href=#__codelineno-10-71>71</a></span>
<span class=normal><a href=#__codelineno-10-72>72</a></span>
<span class=normal><a href=#__codelineno-10-73>73</a></span>
<span class=normal><a href=#__codelineno-10-74>74</a></span>
<span class=normal><a href=#__codelineno-10-75>75</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1></a>L6
<a id=__codelineno-10-2 name=__codelineno-10-2></a> ALOAD 0
<a id=__codelineno-10-3 name=__codelineno-10-3></a><span class=hll> LDC &quot;Y29tLmtldmxhci5zaG93Y2FzZQ==&quot;
</span><a id=__codelineno-10-4 name=__codelineno-10-4></a> ASTORE 3
<a id=__codelineno-10-5 name=__codelineno-10-5></a> GETSTATIC kotlin/text/Charsets.UTF_8 : Ljava/nio/charset/Charset;
<a id=__codelineno-10-6 name=__codelineno-10-6></a> ASTORE 4
<a id=__codelineno-10-7 name=__codelineno-10-7></a>L7
<a id=__codelineno-10-8 name=__codelineno-10-8></a> ALOAD 3
<a id=__codelineno-10-9 name=__codelineno-10-9></a>L8
<a id=__codelineno-10-10 name=__codelineno-10-10></a> ALOAD 4
<a id=__codelineno-10-11 name=__codelineno-10-11></a> INVOKEVIRTUAL java/lang/String.getBytes (Ljava/nio/charset/Charset;)[B
<a id=__codelineno-10-12 name=__codelineno-10-12></a> DUP
<a id=__codelineno-10-13 name=__codelineno-10-13></a> LDC &quot;(this as java.lang.String).getBytes(charset)&quot;
<a id=__codelineno-10-14 name=__codelineno-10-14></a> INVOKESTATIC kotlin/jvm/internal/Intrinsics.checkNotNullExpressionValue (Ljava/lang/Object;Ljava/lang/String;)V
<a id=__codelineno-10-15 name=__codelineno-10-15></a>L9
<a id=__codelineno-10-16 name=__codelineno-10-16></a> PUTFIELD com/kevlar/showcase/data/repo/IntegrityRepository.packageName : [B
<a id=__codelineno-10-17 name=__codelineno-10-17></a>L10
<a id=__codelineno-10-18 name=__codelineno-10-18></a> ALOAD 0
<a id=__codelineno-10-19 name=__codelineno-10-19></a><span class=hll> LDC &quot;SitucVhMZnVJTzhCMkFtaGtNWUhHRTRqRHl3PQ==&quot;
</span><a id=__codelineno-10-20 name=__codelineno-10-20></a> ASTORE 3
<a id=__codelineno-10-21 name=__codelineno-10-21></a> GETSTATIC kotlin/text/Charsets.UTF_8 : Ljava/nio/charset/Charset;
<a id=__codelineno-10-22 name=__codelineno-10-22></a> ASTORE 4
<a id=__codelineno-10-23 name=__codelineno-10-23></a>L11
<a id=__codelineno-10-24 name=__codelineno-10-24></a> ALOAD 3
<a id=__codelineno-10-25 name=__codelineno-10-25></a>L12
<a id=__codelineno-10-26 name=__codelineno-10-26></a> ALOAD 4
<a id=__codelineno-10-27 name=__codelineno-10-27></a> INVOKEVIRTUAL java/lang/String.getBytes (Ljava/nio/charset/Charset;)[B
<a id=__codelineno-10-28 name=__codelineno-10-28></a> DUP
<a id=__codelineno-10-29 name=__codelineno-10-29></a> LDC &quot;(this as java.lang.String).getBytes(charset)&quot;
<a id=__codelineno-10-30 name=__codelineno-10-30></a> INVOKESTATIC kotlin/jvm/internal/Intrinsics.checkNotNullExpressionValue (Ljava/lang/Object;Ljava/lang/String;)V
<a id=__codelineno-10-31 name=__codelineno-10-31></a>L13
<a id=__codelineno-10-32 name=__codelineno-10-32></a> PUTFIELD com/kevlar/showcase/data/repo/IntegrityRepository.signature : [B
<a id=__codelineno-10-33 name=__codelineno-10-33></a>L14
<a id=__codelineno-10-34 name=__codelineno-10-34></a> ALOAD 0
<a id=__codelineno-10-35 name=__codelineno-10-35></a> NEW com/kevlar/integrity/model/HardcodedMetadata
<a id=__codelineno-10-36 name=__codelineno-10-36></a> DUP
<a id=__codelineno-10-37 name=__codelineno-10-37></a>L15
<a id=__codelineno-10-38 name=__codelineno-10-38></a> ALOAD 0
<a id=__codelineno-10-39 name=__codelineno-10-39></a> GETFIELD com/kevlar/showcase/data/repo/IntegrityRepository.packageName : [B
<a id=__codelineno-10-40 name=__codelineno-10-40></a> ICONST_0
<a id=__codelineno-10-41 name=__codelineno-10-41></a> INVOKESTATIC android/util/Base64.decode ([BI)[B
<a id=__codelineno-10-42 name=__codelineno-10-42></a> DUP
<a id=__codelineno-10-43 name=__codelineno-10-43></a> LDC &quot;Base64.decode(packageName, Base64.DEFAULT)&quot;
<a id=__codelineno-10-44 name=__codelineno-10-44></a> INVOKESTATIC kotlin/jvm/internal/Intrinsics.checkNotNullExpressionValue (Ljava/lang/Object;Ljava/lang/String;)V
<a id=__codelineno-10-45 name=__codelineno-10-45></a> ASTORE 3
<a id=__codelineno-10-46 name=__codelineno-10-46></a> GETSTATIC kotlin/text/Charsets.UTF_8 : Ljava/nio/charset/Charset;
<a id=__codelineno-10-47 name=__codelineno-10-47></a> ASTORE 4
<a id=__codelineno-10-48 name=__codelineno-10-48></a>L16
<a id=__codelineno-10-49 name=__codelineno-10-49></a> NEW java/lang/String
<a id=__codelineno-10-50 name=__codelineno-10-50></a> DUP
<a id=__codelineno-10-51 name=__codelineno-10-51></a> ALOAD 3
<a id=__codelineno-10-52 name=__codelineno-10-52></a> ALOAD 4
<a id=__codelineno-10-53 name=__codelineno-10-53></a> INVOKESPECIAL java/lang/String.&lt;init&gt; ([BLjava/nio/charset/Charset;)V
<a id=__codelineno-10-54 name=__codelineno-10-54></a>L17
<a id=__codelineno-10-55 name=__codelineno-10-55></a>L18
<a id=__codelineno-10-56 name=__codelineno-10-56></a> ALOAD 0
<a id=__codelineno-10-57 name=__codelineno-10-57></a> GETFIELD com/kevlar/showcase/data/repo/IntegrityRepository.signature : [B
<a id=__codelineno-10-58 name=__codelineno-10-58></a> ICONST_0
<a id=__codelineno-10-59 name=__codelineno-10-59></a> INVOKESTATIC android/util/Base64.decode ([BI)[B
<a id=__codelineno-10-60 name=__codelineno-10-60></a> DUP
<a id=__codelineno-10-61 name=__codelineno-10-61></a> LDC &quot;Base64.decode(signature, Base64.DEFAULT)&quot;
<a id=__codelineno-10-62 name=__codelineno-10-62></a> INVOKESTATIC kotlin/jvm/internal/Intrinsics.checkNotNullExpressionValue (Ljava/lang/Object;Ljava/lang/String;)V
<a id=__codelineno-10-63 name=__codelineno-10-63></a> ASTORE 3
<a id=__codelineno-10-64 name=__codelineno-10-64></a> GETSTATIC kotlin/text/Charsets.UTF_8 : Ljava/nio/charset/Charset;
<a id=__codelineno-10-65 name=__codelineno-10-65></a> ASTORE 4
<a id=__codelineno-10-66 name=__codelineno-10-66></a>L19
<a id=__codelineno-10-67 name=__codelineno-10-67></a> NEW java/lang/String
<a id=__codelineno-10-68 name=__codelineno-10-68></a> DUP
<a id=__codelineno-10-69 name=__codelineno-10-69></a> ALOAD 3
<a id=__codelineno-10-70 name=__codelineno-10-70></a> ALOAD 4
<a id=__codelineno-10-71 name=__codelineno-10-71></a> INVOKESPECIAL java/lang/String.&lt;init&gt; ([BLjava/nio/charset/Charset;)V
<a id=__codelineno-10-72 name=__codelineno-10-72></a>L20
<a id=__codelineno-10-73 name=__codelineno-10-73></a>L21
<a id=__codelineno-10-74 name=__codelineno-10-74></a> INVOKESPECIAL com/kevlar/integrity/model/HardcodedMetadata.&lt;init&gt; (Ljava/lang/String;Ljava/lang/String;)V
<a id=__codelineno-10-75 name=__codelineno-10-75></a> PUTFIELD com/kevlar/showcase/data/repo/IntegrityRepository.base64ObfuscatedHardcodedMetadata : Lcom/kevlar/integrity/model/HardcodedMetadata;
</code></pre></div></td></tr></table></div> </details> <h3 id=encryption-base64>Encryption (+base64)<a class=headerlink href=#encryption-base64 title="Permanent link">&para;</a></h3> <p>A better alternative is to encrypt the hardcoded metadata, store them in an encrypted form, and send them through a decryption function when creating <code>HardcodedMetadata</code>.</p> <div class=highlight><span class=filename>encrypted_hardcoded_metadata.kt</span><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=c1>// Our arbitrary 256-bit encryption key</span><span class=w></span>
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>aesKey256</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;&quot;&quot;4t7w!z%C*F-JaNcRfUjXn2r5u8x/A?Ds&quot;&quot;&quot;</span><span class=w></span>
<a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>
<a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=c1>// This is &quot;com.kevlar.showcase&quot;, encrypted using AES256 with the previous key</span><span class=w></span>
<a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>encryptedPackageName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;&quot;&quot;s3wf/AOYtr9BEMVFrweeLnkmerryUykMA8O77S5tMlI=&quot;&quot;&quot;</span><span class=p>.</span><span class=na>toByteArray</span><span class=p>()</span><span class=w></span>
<a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a>
<a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=c1>// This is &quot;J+nqXLfuIO8B2AmhkMYHGE4jDyw=&quot;, encrypted using AES256 with the previous key</span><span class=w></span>
<a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>encryptedSignature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;&quot;&quot;tqMJquO3D+EKx1rx4R7/qzmsuEgpp1bKwxXe9AeB/WU=&quot;&quot;&quot;</span><span class=p>.</span><span class=na>toByteArray</span><span class=p>()</span><span class=w></span>
<a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a>
<a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a>
<a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>aes256EncryptedHardcodedPackageName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HardcodedPackageName</span><span class=p>(</span><span class=w></span>
<a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a><span class=w>    </span><span class=n>packageName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>EncryptionUtil</span><span class=p>.</span><span class=na>decrypt</span><span class=p>(</span><span class=w></span>
<a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a><span class=w>        </span><span class=n>encryptedPackageName</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a><span class=w>        </span><span class=n>EncryptionUtil</span><span class=p>.</span><span class=na>generateKey</span><span class=p>(</span><span class=n>aesKey256</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-11-15 name=__codelineno-11-15 href=#__codelineno-11-15></a><span class=w>    </span><span class=p>)</span><span class=w></span>
<a id=__codelineno-11-16 name=__codelineno-11-16 href=#__codelineno-11-16></a><span class=p>)</span><span class=w></span>
<a id=__codelineno-11-17 name=__codelineno-11-17 href=#__codelineno-11-17></a>
<a id=__codelineno-11-18 name=__codelineno-11-18 href=#__codelineno-11-18></a><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>aes256EncryptedHardcodedSignatures</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HardcodedBase64EncodedSignature</span><span class=p>(</span><span class=w></span>
<a id=__codelineno-11-19 name=__codelineno-11-19 href=#__codelineno-11-19></a><span class=w>    </span><span class=n>EncryptionUtil</span><span class=p>.</span><span class=na>decrypt</span><span class=p>(</span><span class=n>encryptedSignature</span><span class=p>,</span><span class=w> </span><span class=n>EncryptionUtil</span><span class=p>.</span><span class=na>generateKey</span><span class=p>(</span><span class=n>aesKey256</span><span class=p>))</span><span class=w></span>
<a id=__codelineno-11-20 name=__codelineno-11-20 href=#__codelineno-11-20></a><span class=p>)</span><span class=w></span>
</code></pre></div> <p>Where <code>7KAa2CFkhPQOUouDu32KZJLqOzGFbTTnJA3rGxMlAg4=</code> is the encrypted value of <code>com.kevlar.showcase</code>, and <code>+ylMx63kwFRmXKHQU0cbzyb8MJ1iiGW1g8+MjDRcS/o=</code> of <code>J+nqXLfuIO8B2AmhkMYHGE4jDyw=</code>.</p> <p>This ensures that there is no possibility that an automatic attack picks up the string as a package name or signature, and trivial string substitutions or encodings like base64 won't give any information away (the ciphertext is encoded in base64).</p> <p>AES128 or AES256 is recommended as the encryption algorithm (it's a little overkill but it does the job).</p> <p>The ciphertext may also be stored as a byte array.</p> <details class=tldr> <summary>Encryption utility</summary> <p><a href=https://github.com/kevlar-kt/kevlar/blob/master/showcase/src/main/kotlin/com/kevlar/showcase/util/EncryptionUtil.kt>This</a> tiny class (from the showcase module in the repository) is a basic AES encryption/decryption utility.</p> <div class=highlight><span class=filename>EncryptionUtil.kt</span><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=k>import</span><span class=w> </span><span class=nn>android.util.Base64</span><span class=w></span>
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=k>import</span><span class=w> </span><span class=nn>javax.crypto.Cipher</span><span class=w></span>
<a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=k>import</span><span class=w> </span><span class=nn>javax.crypto.SecretKey</span><span class=w></span>
<a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=k>import</span><span class=w> </span><span class=nn>javax.crypto.spec.SecretKeySpec</span><span class=w></span>
<a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>
<a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=kd>object</span><span class=w> </span><span class=nc>EncryptionUtil</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>algorithm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;AES&quot;</span><span class=w></span>
<a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>transformation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;AES/ECB/PKCS5Padding&quot;</span><span class=w></span>
<a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a>
<a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a><span class=w>    </span><span class=kd>fun</span><span class=w> </span><span class=nf>generateKey</span><span class=p>(</span><span class=n>key</span><span class=p>:</span><span class=w> </span><span class=kt>String</span><span class=p>):</span><span class=w> </span><span class=n>SecretKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SecretKeySpec</span><span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=na>toByteArray</span><span class=p>(),</span><span class=w> </span><span class=n>algorithm</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a>
<a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a><span class=w>    </span><span class=kd>fun</span><span class=w> </span><span class=nf>encrypt</span><span class=p>(</span><span class=n>text</span><span class=p>:</span><span class=w> </span><span class=n>ByteArray</span><span class=p>,</span><span class=w> </span><span class=n>secret</span><span class=p>:</span><span class=w> </span><span class=n>SecretKey</span><span class=p>):</span><span class=w> </span><span class=kt>String</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a><span class=w>        </span><span class=kd>val</span><span class=w> </span><span class=nv>cipher</span><span class=p>:</span><span class=w> </span><span class=n>Cipher</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Cipher</span><span class=p>.</span><span class=na>getInstance</span><span class=p>(</span><span class=n>transformation</span><span class=p>).</span><span class=na>apply</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-12-14 name=__codelineno-12-14 href=#__codelineno-12-14></a><span class=w>            </span><span class=k>init</span><span class=p>(</span><span class=n>Cipher</span><span class=p>.</span><span class=na>ENCRYPT_MODE</span><span class=p>,</span><span class=w> </span><span class=n>secret</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-12-15 name=__codelineno-12-15 href=#__codelineno-12-15></a><span class=w>        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-12-16 name=__codelineno-12-16 href=#__codelineno-12-16></a>
<a id=__codelineno-12-17 name=__codelineno-12-17 href=#__codelineno-12-17></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Base64</span><span class=p>.</span><span class=na>encodeToString</span><span class=p>(</span><span class=n>cipher</span><span class=p>.</span><span class=na>doFinal</span><span class=p>(</span><span class=n>text</span><span class=p>),</span><span class=w> </span><span class=n>Base64</span><span class=p>.</span><span class=na>NO_WRAP</span><span class=p>)</span><span class=w> </span><span class=o>?:</span><span class=w> </span><span class=s>&quot;&quot;</span><span class=w></span>
<a id=__codelineno-12-18 name=__codelineno-12-18 href=#__codelineno-12-18></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-12-19 name=__codelineno-12-19 href=#__codelineno-12-19></a>
<a id=__codelineno-12-20 name=__codelineno-12-20 href=#__codelineno-12-20></a><span class=w>    </span><span class=kd>fun</span><span class=w> </span><span class=nf>decrypt</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>:</span><span class=w> </span><span class=n>ByteArray</span><span class=p>,</span><span class=w> </span><span class=n>secret</span><span class=p>:</span><span class=w> </span><span class=n>SecretKey</span><span class=p>):</span><span class=w> </span><span class=kt>String</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-12-21 name=__codelineno-12-21 href=#__codelineno-12-21></a><span class=w>        </span><span class=kd>val</span><span class=w> </span><span class=nv>cipher</span><span class=p>:</span><span class=w> </span><span class=n>Cipher</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Cipher</span><span class=p>.</span><span class=na>getInstance</span><span class=p>(</span><span class=n>transformation</span><span class=p>).</span><span class=na>apply</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-12-22 name=__codelineno-12-22 href=#__codelineno-12-22></a><span class=w>            </span><span class=k>init</span><span class=p>(</span><span class=n>Cipher</span><span class=p>.</span><span class=na>DECRYPT_MODE</span><span class=p>,</span><span class=w> </span><span class=n>secret</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-12-23 name=__codelineno-12-23 href=#__codelineno-12-23></a><span class=w>        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-12-24 name=__codelineno-12-24 href=#__codelineno-12-24></a>
<a id=__codelineno-12-25 name=__codelineno-12-25 href=#__codelineno-12-25></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kt>String</span><span class=p>(</span><span class=n>cipher</span><span class=p>.</span><span class=na>doFinal</span><span class=p>(</span><span class=n>Base64</span><span class=p>.</span><span class=na>decode</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>,</span><span class=w> </span><span class=n>Base64</span><span class=p>.</span><span class=na>NO_WRAP</span><span class=p>)),</span><span class=w> </span><span class=n>Charsets</span><span class=p>.</span><span class=na>UTF_8</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-12-26 name=__codelineno-12-26 href=#__codelineno-12-26></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-12-27 name=__codelineno-12-27 href=#__codelineno-12-27></a><span class=p>}</span><span class=w></span>
</code></pre></div> </details> <details class=bug> <summary>Bytecode</summary> <p>Here detecting and reconstructing the original package name automatically is basically impossible</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-13-1> 1</a></span>
<span class=normal><a href=#__codelineno-13-2> 2</a></span>
<span class=normal><a href=#__codelineno-13-3> 3</a></span>
<span class=normal><a href=#__codelineno-13-4> 4</a></span>
<span class=normal><a href=#__codelineno-13-5> 5</a></span>
<span class=normal><a href=#__codelineno-13-6> 6</a></span>
<span class=normal><a href=#__codelineno-13-7> 7</a></span>
<span class=normal><a href=#__codelineno-13-8> 8</a></span>
<span class=normal><a href=#__codelineno-13-9> 9</a></span>
<span class=normal><a href=#__codelineno-13-10>10</a></span>
<span class=normal><a href=#__codelineno-13-11>11</a></span>
<span class=normal><a href=#__codelineno-13-12>12</a></span>
<span class=normal><a href=#__codelineno-13-13>13</a></span>
<span class=normal><a href=#__codelineno-13-14>14</a></span>
<span class=normal><a href=#__codelineno-13-15>15</a></span>
<span class=normal><a href=#__codelineno-13-16>16</a></span>
<span class=normal><a href=#__codelineno-13-17>17</a></span>
<span class=normal><a href=#__codelineno-13-18>18</a></span>
<span class=normal><a href=#__codelineno-13-19>19</a></span>
<span class=normal><a href=#__codelineno-13-20>20</a></span>
<span class=normal><a href=#__codelineno-13-21>21</a></span>
<span class=normal><a href=#__codelineno-13-22>22</a></span>
<span class=normal><a href=#__codelineno-13-23>23</a></span>
<span class=normal><a href=#__codelineno-13-24>24</a></span>
<span class=normal><a href=#__codelineno-13-25>25</a></span>
<span class=normal><a href=#__codelineno-13-26>26</a></span>
<span class=normal><a href=#__codelineno-13-27>27</a></span>
<span class=normal><a href=#__codelineno-13-28>28</a></span>
<span class=normal><a href=#__codelineno-13-29>29</a></span>
<span class=normal><a href=#__codelineno-13-30>30</a></span>
<span class=normal><a href=#__codelineno-13-31>31</a></span>
<span class=normal><a href=#__codelineno-13-32>32</a></span>
<span class=normal><a href=#__codelineno-13-33>33</a></span>
<span class=normal><a href=#__codelineno-13-34>34</a></span>
<span class=normal><a href=#__codelineno-13-35>35</a></span>
<span class=normal><a href=#__codelineno-13-36>36</a></span>
<span class=normal><a href=#__codelineno-13-37>37</a></span>
<span class=normal><a href=#__codelineno-13-38>38</a></span>
<span class=normal><a href=#__codelineno-13-39>39</a></span>
<span class=normal><a href=#__codelineno-13-40>40</a></span>
<span class=normal><a href=#__codelineno-13-41>41</a></span>
<span class=normal><a href=#__codelineno-13-42>42</a></span>
<span class=normal><a href=#__codelineno-13-43>43</a></span>
<span class=normal><a href=#__codelineno-13-44>44</a></span>
<span class=normal><a href=#__codelineno-13-45>45</a></span>
<span class=normal><a href=#__codelineno-13-46>46</a></span>
<span class=normal><a href=#__codelineno-13-47>47</a></span>
<span class=normal><a href=#__codelineno-13-48>48</a></span>
<span class=normal><a href=#__codelineno-13-49>49</a></span>
<span class=normal><a href=#__codelineno-13-50>50</a></span>
<span class=normal><a href=#__codelineno-13-51>51</a></span>
<span class=normal><a href=#__codelineno-13-52>52</a></span>
<span class=normal><a href=#__codelineno-13-53>53</a></span>
<span class=normal><a href=#__codelineno-13-54>54</a></span>
<span class=normal><a href=#__codelineno-13-55>55</a></span>
<span class=normal><a href=#__codelineno-13-56>56</a></span>
<span class=normal><a href=#__codelineno-13-57>57</a></span>
<span class=normal><a href=#__codelineno-13-58>58</a></span>
<span class=normal><a href=#__codelineno-13-59>59</a></span>
<span class=normal><a href=#__codelineno-13-60>60</a></span>
<span class=normal><a href=#__codelineno-13-61>61</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1></a>L22
<a id=__codelineno-13-2 name=__codelineno-13-2></a> ALOAD 0
<a id=__codelineno-13-3 name=__codelineno-13-3></a> LDC &quot;4t7w!z%C*F-JaNcRfUjXn2r5u8x/A?Ds&quot;
<a id=__codelineno-13-4 name=__codelineno-13-4></a> PUTFIELD com/kevlar/showcase/data/repo/IntegrityRepository.key256 : Ljava/lang/String;
<a id=__codelineno-13-5 name=__codelineno-13-5></a>L23
<a id=__codelineno-13-6 name=__codelineno-13-6></a> ALOAD 0
<a id=__codelineno-13-7 name=__codelineno-13-7></a><span class=hll> LDC &quot;s3wf/AOYtr9BEMVFrweeLnkmerryUykMA8O77S5tMlI=&quot;
</span><a id=__codelineno-13-8 name=__codelineno-13-8></a> ASTORE 3
<a id=__codelineno-13-9 name=__codelineno-13-9></a> GETSTATIC kotlin/text/Charsets.UTF_8 : Ljava/nio/charset/Charset;
<a id=__codelineno-13-10 name=__codelineno-13-10></a> ASTORE 4
<a id=__codelineno-13-11 name=__codelineno-13-11></a>L24
<a id=__codelineno-13-12 name=__codelineno-13-12></a> ALOAD 3
<a id=__codelineno-13-13 name=__codelineno-13-13></a>L25
<a id=__codelineno-13-14 name=__codelineno-13-14></a> ALOAD 4
<a id=__codelineno-13-15 name=__codelineno-13-15></a> INVOKEVIRTUAL java/lang/String.getBytes (Ljava/nio/charset/Charset;)[B
<a id=__codelineno-13-16 name=__codelineno-13-16></a> DUP
<a id=__codelineno-13-17 name=__codelineno-13-17></a> LDC &quot;(this as java.lang.String).getBytes(charset)&quot;
<a id=__codelineno-13-18 name=__codelineno-13-18></a> INVOKESTATIC kotlin/jvm/internal/Intrinsics.checkNotNullExpressionValue (Ljava/lang/Object;Ljava/lang/String;)V
<a id=__codelineno-13-19 name=__codelineno-13-19></a>L26
<a id=__codelineno-13-20 name=__codelineno-13-20></a> PUTFIELD com/kevlar/showcase/data/repo/IntegrityRepository.encryptedPackageName : [B
<a id=__codelineno-13-21 name=__codelineno-13-21></a>L27
<a id=__codelineno-13-22 name=__codelineno-13-22></a> ALOAD 0
<a id=__codelineno-13-23 name=__codelineno-13-23></a><span class=hll> LDC &quot;tqMJquO3D+EKx1rx4R7/qzmsuEgpp1bKwxXe9AeB/WU=&quot;
</span><a id=__codelineno-13-24 name=__codelineno-13-24></a> ASTORE 3
<a id=__codelineno-13-25 name=__codelineno-13-25></a> GETSTATIC kotlin/text/Charsets.UTF_8 : Ljava/nio/charset/Charset;
<a id=__codelineno-13-26 name=__codelineno-13-26></a> ASTORE 4
<a id=__codelineno-13-27 name=__codelineno-13-27></a>L28
<a id=__codelineno-13-28 name=__codelineno-13-28></a> ALOAD 3
<a id=__codelineno-13-29 name=__codelineno-13-29></a>L29
<a id=__codelineno-13-30 name=__codelineno-13-30></a> ALOAD 4
<a id=__codelineno-13-31 name=__codelineno-13-31></a> INVOKEVIRTUAL java/lang/String.getBytes (Ljava/nio/charset/Charset;)[B
<a id=__codelineno-13-32 name=__codelineno-13-32></a> DUP
<a id=__codelineno-13-33 name=__codelineno-13-33></a> LDC &quot;(this as java.lang.String).getBytes(charset)&quot;
<a id=__codelineno-13-34 name=__codelineno-13-34></a> INVOKESTATIC kotlin/jvm/internal/Intrinsics.checkNotNullExpressionValue (Ljava/lang/Object;Ljava/lang/String;)V
<a id=__codelineno-13-35 name=__codelineno-13-35></a>L30
<a id=__codelineno-13-36 name=__codelineno-13-36></a> PUTFIELD com/kevlar/showcase/data/repo/IntegrityRepository.encryptedSignature : [B
<a id=__codelineno-13-37 name=__codelineno-13-37></a>L31
<a id=__codelineno-13-38 name=__codelineno-13-38></a> ALOAD 0
<a id=__codelineno-13-39 name=__codelineno-13-39></a> NEW com/kevlar/integrity/model/HardcodedMetadata
<a id=__codelineno-13-40 name=__codelineno-13-40></a> DUP
<a id=__codelineno-13-41 name=__codelineno-13-41></a>L32
<a id=__codelineno-13-42 name=__codelineno-13-42></a> GETSTATIC com/kevlar/showcase/util/EncryptionUtil.INSTANCE : Lcom/kevlar/showcase/util/EncryptionUtil;
<a id=__codelineno-13-43 name=__codelineno-13-43></a> ALOAD 0
<a id=__codelineno-13-44 name=__codelineno-13-44></a> GETFIELD com/kevlar/showcase/data/repo/IntegrityRepository.encryptedPackageName : [B
<a id=__codelineno-13-45 name=__codelineno-13-45></a> GETSTATIC com/kevlar/showcase/util/EncryptionUtil.INSTANCE : Lcom/kevlar/showcase/util/EncryptionUtil;
<a id=__codelineno-13-46 name=__codelineno-13-46></a> ALOAD 0
<a id=__codelineno-13-47 name=__codelineno-13-47></a> GETFIELD com/kevlar/showcase/data/repo/IntegrityRepository.key256 : Ljava/lang/String;
<a id=__codelineno-13-48 name=__codelineno-13-48></a> INVOKEVIRTUAL com/kevlar/showcase/util/EncryptionUtil.generateKey (Ljava/lang/String;)Ljavax/crypto/SecretKey;
<a id=__codelineno-13-49 name=__codelineno-13-49></a> INVOKEVIRTUAL com/kevlar/showcase/util/EncryptionUtil.decrypt ([BLjavax/crypto/SecretKey;)Ljava/lang/String;
<a id=__codelineno-13-50 name=__codelineno-13-50></a>L33
<a id=__codelineno-13-51 name=__codelineno-13-51></a> GETSTATIC com/kevlar/showcase/util/EncryptionUtil.INSTANCE : Lcom/kevlar/showcase/util/EncryptionUtil;
<a id=__codelineno-13-52 name=__codelineno-13-52></a> ALOAD 0
<a id=__codelineno-13-53 name=__codelineno-13-53></a> GETFIELD com/kevlar/showcase/data/repo/IntegrityRepository.encryptedSignature : [B
<a id=__codelineno-13-54 name=__codelineno-13-54></a> GETSTATIC com/kevlar/showcase/util/EncryptionUtil.INSTANCE : Lcom/kevlar/showcase/util/EncryptionUtil;
<a id=__codelineno-13-55 name=__codelineno-13-55></a> ALOAD 0
<a id=__codelineno-13-56 name=__codelineno-13-56></a> GETFIELD com/kevlar/showcase/data/repo/IntegrityRepository.key256 : Ljava/lang/String;
<a id=__codelineno-13-57 name=__codelineno-13-57></a> INVOKEVIRTUAL com/kevlar/showcase/util/EncryptionUtil.generateKey (Ljava/lang/String;)Ljavax/crypto/SecretKey;
<a id=__codelineno-13-58 name=__codelineno-13-58></a> INVOKEVIRTUAL com/kevlar/showcase/util/EncryptionUtil.decrypt ([BLjavax/crypto/SecretKey;)Ljava/lang/String;
<a id=__codelineno-13-59 name=__codelineno-13-59></a>L34
<a id=__codelineno-13-60 name=__codelineno-13-60></a> INVOKESPECIAL com/kevlar/integrity/model/HardcodedMetadata.&lt;init&gt; (Ljava/lang/String;Ljava/lang/String;)V
<a id=__codelineno-13-61 name=__codelineno-13-61></a> PUTFIELD com/kevlar/showcase/data/repo/IntegrityRepository.aes256EncryptedHardcodedMetadata : Lcom/kevlar/integrity/model/HardcodedMetadata;
</code></pre></div></td></tr></table></div> </details> <h3 id=hashing>Hashing<a class=headerlink href=#hashing title="Permanent link">&para;</a></h3> <p>This hasn't been developed yet, but it may be possible to let kevlar know only the hash of your hardcoded data, and let it match directly on the runtime signatures and package names hashes. This would require multiple options of composite hash functions to be secure enough. It is not implemented.</p> <h2 id=initialization-attestations>Initialization &amp; Attestations<a class=headerlink href=#initialization-attestations title="Permanent link">&para;</a></h2> <p>You need to create a <code>KevlarIntegrity</code> instance (which is the way you will be requesting attestations), along with your desired parameters (either global, local or in your repository layer, if you are using MVVM/MVC).</p> <p>Once you have that, you just go ahead and call <code>integrity.attestate()</code> in a coroutine and your application running metadata will be checked, according to the provided parameters.</p> <p><code>IntegrityAttestation</code> will be returned from the call (it's a sealed class), containing the checks which failed, if any.</p> <p>Note that we will be initializing <code>KevlarIntegrity</code> with custom scan settings, but you could leave it as default.</p> <h2 id=in-place>In-Place<a class=headerlink href=#in-place title="Permanent link">&para;</a></h2> <p>This is the most concise (and complete) way to implement this package.</p> <div class=highlight><span class=filename>InPlace.kt</span><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=cm>/**</span>
<a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=cm> * Base64 obfuscated package name and signature</span>
<a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=cm> * */</span><span class=w></span>
<a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=c1>// Original value is &quot;com.kevlar.showcase&quot;, the package name hardcoded value</span><span class=w></span>
<a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>base64EncodedPackageName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;&quot;&quot;Y29tLmtldmxhci5zaG93Y2FzZQ==&quot;&quot;&quot;</span><span class=p>.</span><span class=na>toByteArray</span><span class=p>()</span><span class=w></span>
<a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a>
<a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>base64ObfuscatedHardcodedPackageName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HardcodedPackageName</span><span class=p>(</span><span class=w></span>
<a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=w>    </span><span class=n>packageName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Base64</span><span class=p>.</span><span class=na>decode</span><span class=p>(</span><span class=n>base64EncodedPackageName</span><span class=p>,</span><span class=w> </span><span class=n>Base64</span><span class=p>.</span><span class=na>DEFAULT</span><span class=p>).</span><span class=na>toString</span><span class=p>(</span><span class=n>Charsets</span><span class=p>.</span><span class=na>UTF_8</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=p>)</span><span class=w></span>
<a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a>
<a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a>
<a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a>
<a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a><span class=c1>// Original value is &quot;J+nqXLfuIO8B2AmhkMYHGE4jDyw=&quot;, the signature hardcoded value</span><span class=w></span>
<a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>base64EncodedSignature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;&quot;&quot;SitucVhMZnVJTzhCMkFtaGtNWUhHRTRqRHl3PQ==&quot;&quot;&quot;</span><span class=p>.</span><span class=na>toByteArray</span><span class=p>()</span><span class=w></span>
<a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a>
<a id=__codelineno-14-16 name=__codelineno-14-16 href=#__codelineno-14-16></a><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>base64ObfuscatedHardcodedSignatures</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HardcodedBase64EncodedSignature</span><span class=p>(</span><span class=w></span>
<a id=__codelineno-14-17 name=__codelineno-14-17 href=#__codelineno-14-17></a><span class=w>    </span><span class=n>Base64</span><span class=p>.</span><span class=na>decode</span><span class=p>(</span><span class=n>base64EncodedSignature</span><span class=p>,</span><span class=w> </span><span class=n>Base64</span><span class=p>.</span><span class=na>DEFAULT</span><span class=p>).</span><span class=na>toString</span><span class=p>(</span><span class=n>Charsets</span><span class=p>.</span><span class=na>UTF_8</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-14-18 name=__codelineno-14-18 href=#__codelineno-14-18></a><span class=p>)</span><span class=w></span>
<a id=__codelineno-14-19 name=__codelineno-14-19 href=#__codelineno-14-19></a>
<a id=__codelineno-14-20 name=__codelineno-14-20 href=#__codelineno-14-20></a>
<a id=__codelineno-14-21 name=__codelineno-14-21 href=#__codelineno-14-21></a><span class=cm>/**</span>
<a id=__codelineno-14-22 name=__codelineno-14-22 href=#__codelineno-14-22></a><span class=cm> * Integrity package</span>
<a id=__codelineno-14-23 name=__codelineno-14-23 href=#__codelineno-14-23></a><span class=cm> * */</span><span class=w></span>
<a id=__codelineno-14-24 name=__codelineno-14-24 href=#__codelineno-14-24></a><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>integrity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>KevlarIntegrity</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-14-25 name=__codelineno-14-25 href=#__codelineno-14-25></a><span class=w>    </span><span class=n>checks</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-14-26 name=__codelineno-14-26 href=#__codelineno-14-26></a><span class=w>        </span><span class=n>packageName</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-14-27 name=__codelineno-14-27 href=#__codelineno-14-27></a><span class=w>            </span><span class=n>hardcodedPackageName</span><span class=p>(</span><span class=n>base64ObfuscatedHardcodedPackageName</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-14-28 name=__codelineno-14-28 href=#__codelineno-14-28></a><span class=w>        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-14-29 name=__codelineno-14-29 href=#__codelineno-14-29></a>
<a id=__codelineno-14-30 name=__codelineno-14-30 href=#__codelineno-14-30></a><span class=w>        </span><span class=n>signature</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-14-31 name=__codelineno-14-31 href=#__codelineno-14-31></a><span class=w>            </span><span class=n>hardcodedSignatures</span><span class=p>(</span><span class=n>base64ObfuscatedHardcodedSignatures</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-14-32 name=__codelineno-14-32 href=#__codelineno-14-32></a><span class=w>        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-14-33 name=__codelineno-14-33 href=#__codelineno-14-33></a>
<a id=__codelineno-14-34 name=__codelineno-14-34 href=#__codelineno-14-34></a><span class=w>        </span><span class=n>installer</span><span class=p>()</span><span class=w></span>
<a id=__codelineno-14-35 name=__codelineno-14-35 href=#__codelineno-14-35></a><span class=w>        </span><span class=n>debug</span><span class=p>()</span><span class=w></span>
<a id=__codelineno-14-36 name=__codelineno-14-36 href=#__codelineno-14-36></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-14-37 name=__codelineno-14-37 href=#__codelineno-14-37></a><span class=p>}</span><span class=w></span>
<a id=__codelineno-14-38 name=__codelineno-14-38 href=#__codelineno-14-38></a>
<a id=__codelineno-14-39 name=__codelineno-14-39 href=#__codelineno-14-39></a>
<a id=__codelineno-14-40 name=__codelineno-14-40 href=#__codelineno-14-40></a>
<a id=__codelineno-14-41 name=__codelineno-14-41 href=#__codelineno-14-41></a>
<a id=__codelineno-14-42 name=__codelineno-14-42 href=#__codelineno-14-42></a><span class=o>/**</span><span class=w></span>
<a id=__codelineno-14-43 name=__codelineno-14-43 href=#__codelineno-14-43></a><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>Assestation</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>callback</span><span class=w></span>
<a id=__codelineno-14-44 name=__codelineno-14-44 href=#__codelineno-14-44></a><span class=w> </span><span class=o>*</span><span class=w> </span><span class=o>+/</span><span class=w></span>
<a id=__codelineno-14-45 name=__codelineno-14-45 href=#__codelineno-14-45></a><span class=n>CoroutineScope</span><span class=p>(</span><span class=n>Dispatchers</span><span class=p>.</span><span class=na>Default</span><span class=p>).</span><span class=na>launch</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-14-46 name=__codelineno-14-46 href=#__codelineno-14-46></a><span class=w>    </span><span class=c1>// Attestation request</span><span class=w></span>
<a id=__codelineno-14-47 name=__codelineno-14-47 href=#__codelineno-14-47></a><span class=w>    </span><span class=k>when</span><span class=w> </span><span class=p>(</span><span class=kd>val</span><span class=w> </span><span class=nv>attestation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>integrity</span><span class=p>.</span><span class=na>attestate</span><span class=p>(</span><span class=n>context</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-14-48 name=__codelineno-14-48 href=#__codelineno-14-48></a><span class=w>        </span><span class=k>is</span><span class=w> </span><span class=n>IntegrityAttestation</span><span class=p>.</span><span class=na>Blank</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-14-49 name=__codelineno-14-49 href=#__codelineno-14-49></a><span class=w>            </span><span class=c1>// Pending attestation, no information yet. </span><span class=w></span>
<a id=__codelineno-14-50 name=__codelineno-14-50 href=#__codelineno-14-50></a><span class=w>            </span><span class=c1>// Don&#39;t do anything.</span><span class=w></span>
<a id=__codelineno-14-51 name=__codelineno-14-51 href=#__codelineno-14-51></a><span class=w>        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-14-52 name=__codelineno-14-52 href=#__codelineno-14-52></a><span class=w>        </span><span class=k>is</span><span class=w> </span><span class=n>IntegrityAttestation</span><span class=p>.</span><span class=na>Clear</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-14-53 name=__codelineno-14-53 href=#__codelineno-14-53></a><span class=w>            </span><span class=c1>// Good to go.</span><span class=w></span>
<a id=__codelineno-14-54 name=__codelineno-14-54 href=#__codelineno-14-54></a><span class=w>        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-14-55 name=__codelineno-14-55 href=#__codelineno-14-55></a><span class=w>        </span><span class=k>is</span><span class=w> </span><span class=n>IntegrityAttestation</span><span class=p>.</span><span class=na>Failed</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-14-56 name=__codelineno-14-56 href=#__codelineno-14-56></a><span class=w>            </span><span class=c1>// One or more checks have failed.</span><span class=w></span>
<a id=__codelineno-14-57 name=__codelineno-14-57 href=#__codelineno-14-57></a><span class=w>        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-14-58 name=__codelineno-14-58 href=#__codelineno-14-58></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-14-59 name=__codelineno-14-59 href=#__codelineno-14-59></a><span class=p>}</span><span class=w></span>
</code></pre></div> <p>This packs everything in one file. It is not excellent when writing a modern applications but it does its job.</p> <h2 id=viewmodel-repository-sharedflow-di-with-hilt>ViewModel + Repository + SharedFlow + DI with Hilt<a class=headerlink href=#viewmodel-repository-sharedflow-di-with-hilt title="Permanent link">&para;</a></h2> <h4 id=activity>Activity:<a class=headerlink href=#activity title="Permanent link">&para;</a></h4> <div class=highlight><span class=filename>IntegrityActivity.kt</span><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=nd>@AndroidEntryPoint</span><span class=w></span>
<a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=kd>class</span><span class=w> </span><span class=nc>IntegrityActivity</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>AppCompatActivity</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a>
<a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>vm</span><span class=p>:</span><span class=w> </span><span class=n>ActivityViewModel</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>viewModels</span><span class=p>()</span><span class=w></span>
<a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a>
<a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=w>    </span><span class=kd>override</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>:</span><span class=w> </span><span class=n>Bundle?)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=w>        </span><span class=k>super</span><span class=p>.</span><span class=na>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a>
<a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a><span class=w>        </span><span class=n>lifecycleScope</span><span class=p>.</span><span class=na>launch</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a><span class=w>            </span><span class=n>lifecycle</span><span class=p>.</span><span class=na>repeatOnLifecycle</span><span class=p>(</span><span class=n>Lifecycle</span><span class=p>.</span><span class=na>State</span><span class=p>.</span><span class=na>STARTED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a><span class=w>                </span><span class=n>vm</span><span class=p>.</span><span class=na>attestation</span><span class=p>.</span><span class=na>collectLatest</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-15-12 name=__codelineno-15-12 href=#__codelineno-15-12></a><span class=w>                    </span><span class=k>when</span><span class=w> </span><span class=p>(</span><span class=nb>it</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-15-13 name=__codelineno-15-13 href=#__codelineno-15-13></a><span class=w>                        </span><span class=k>is</span><span class=w> </span><span class=n>IntegrityAttestation</span><span class=p>.</span><span class=na>Blank</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-15-14 name=__codelineno-15-14 href=#__codelineno-15-14></a><span class=w>                            </span><span class=c1>// Pending attestation, no information yet.</span><span class=w></span>
<a id=__codelineno-15-15 name=__codelineno-15-15 href=#__codelineno-15-15></a><span class=w>                            </span><span class=c1>// Don&#39;t do anything.</span><span class=w></span>
<a id=__codelineno-15-16 name=__codelineno-15-16 href=#__codelineno-15-16></a><span class=w>                        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-15-17 name=__codelineno-15-17 href=#__codelineno-15-17></a><span class=w>                        </span><span class=k>is</span><span class=w> </span><span class=n>IntegrityAttestation</span><span class=p>.</span><span class=na>Clear</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-15-18 name=__codelineno-15-18 href=#__codelineno-15-18></a><span class=w>                            </span><span class=c1>// Good to go.</span><span class=w></span>
<a id=__codelineno-15-19 name=__codelineno-15-19 href=#__codelineno-15-19></a><span class=w>                        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-15-20 name=__codelineno-15-20 href=#__codelineno-15-20></a><span class=w>                        </span><span class=k>is</span><span class=w> </span><span class=n>IntegrityAttestation</span><span class=p>.</span><span class=na>Failed</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-15-21 name=__codelineno-15-21 href=#__codelineno-15-21></a><span class=w>                            </span><span class=c1>// Pirate software detected.</span><span class=w></span>
<a id=__codelineno-15-22 name=__codelineno-15-22 href=#__codelineno-15-22></a><span class=w>                        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-15-23 name=__codelineno-15-23 href=#__codelineno-15-23></a><span class=w>                    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-15-24 name=__codelineno-15-24 href=#__codelineno-15-24></a><span class=w>                </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-15-25 name=__codelineno-15-25 href=#__codelineno-15-25></a><span class=w>            </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-15-26 name=__codelineno-15-26 href=#__codelineno-15-26></a><span class=w>        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-15-27 name=__codelineno-15-27 href=#__codelineno-15-27></a>
<a id=__codelineno-15-28 name=__codelineno-15-28 href=#__codelineno-15-28></a><span class=w>        </span><span class=n>CoroutineScope</span><span class=p>(</span><span class=n>Dispatchers</span><span class=p>.</span><span class=na>Main</span><span class=p>).</span><span class=na>launch</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-15-29 name=__codelineno-15-29 href=#__codelineno-15-29></a><span class=w>            </span><span class=n>vm</span><span class=p>.</span><span class=na>requestAttestation</span><span class=p>()</span><span class=w></span>
<a id=__codelineno-15-30 name=__codelineno-15-30 href=#__codelineno-15-30></a><span class=w>        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-15-31 name=__codelineno-15-31 href=#__codelineno-15-31></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-15-32 name=__codelineno-15-32 href=#__codelineno-15-32></a><span class=p>}</span><span class=w></span>
</code></pre></div> <h4 id=view-model>View model:<a class=headerlink href=#view-model title="Permanent link">&para;</a></h4> <div class=highlight><span class=filename>ActivityViewModel.kt</span><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=nd>@HiltViewModel</span><span class=w></span>
<a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=kd>class</span><span class=w> </span><span class=nc>ActivityViewModel</span><span class=w> </span><span class=nd>@Inject</span><span class=w> </span><span class=k>constructor</span><span class=p>(</span><span class=w></span>
<a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>integrityRepository</span><span class=p>:</span><span class=w> </span><span class=n>IntegrityRepository</span><span class=w></span>
<a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>ViewModel</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>_attestation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MutableStateFlow</span><span class=p>(</span><span class=n>KevlarIntegrity</span><span class=p>.</span><span class=na>blankAttestation</span><span class=p>())</span><span class=w></span>
<a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a>
<a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=w>    </span><span class=kd>internal</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>attestation</span><span class=p>:</span><span class=w> </span><span class=n>SharedFlow</span><span class=o>&lt;</span><span class=n>IntegrityAttestation</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_attestation</span><span class=p>.</span><span class=na>stateIn</span><span class=p>(</span><span class=w></span>
<a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=w>        </span><span class=n>viewModelScope</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=w>        </span><span class=n>SharingStarted</span><span class=p>.</span><span class=na>Eagerly</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a><span class=w>        </span><span class=n>initialValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>KevlarIntegrity</span><span class=p>.</span><span class=na>blankAttestation</span><span class=p>()</span><span class=w></span>
<a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a><span class=w>    </span><span class=p>)</span><span class=w></span>
<a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a>
<a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a><span class=w>    </span><span class=kd>fun</span><span class=w> </span><span class=nf>requestAttestation</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a><span class=w>        </span><span class=n>viewModelScope</span><span class=p>.</span><span class=na>launch</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a><span class=w>            </span><span class=n>_attestation</span><span class=p>.</span><span class=na>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>integrityRepository</span><span class=p>.</span><span class=na>attestate</span><span class=p>()</span><span class=w></span>
<a id=__codelineno-16-16 name=__codelineno-16-16 href=#__codelineno-16-16></a><span class=w>        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-16-17 name=__codelineno-16-17 href=#__codelineno-16-17></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-16-18 name=__codelineno-16-18 href=#__codelineno-16-18></a><span class=p>}</span><span class=w></span>
</code></pre></div> <h4 id=repository>Repository<a class=headerlink href=#repository title="Permanent link">&para;</a></h4> <div class=highlight><span class=filename>IntegrityRepository.kt</span><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=kd>class</span><span class=w> </span><span class=nc>IntegrityRepository</span><span class=w> </span><span class=nd>@Inject</span><span class=w> </span><span class=k>constructor</span><span class=p>(</span><span class=w></span>
<a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=w>    </span><span class=nd>@ApplicationContext</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>context</span><span class=p>:</span><span class=w> </span><span class=n>Context</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=w>    </span><span class=nd>@IoDispatcher</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>externalDispatcher</span><span class=p>:</span><span class=w> </span><span class=n>CoroutineDispatcher</span><span class=w></span>
<a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=w>    </span><span class=cm>/**</span>
<a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=cm>     * Base64 obfuscated package name</span>
<a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=cm>     * */</span><span class=w></span>
<a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>base64PackageName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;&quot;&quot;Y29tLmtldmxhci5zaG93Y2FzZQ==&quot;&quot;&quot;</span><span class=p>.</span><span class=na>toByteArray</span><span class=p>()</span><span class=w></span>
<a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>base64Signature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;&quot;&quot;SitucVhMZnVJTzhCMkFtaGtNWUhHRTRqRHl3PQ==&quot;&quot;&quot;</span><span class=p>.</span><span class=na>toByteArray</span><span class=p>()</span><span class=w></span>
<a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a>
<a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a>
<a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>base64ObfuscatedHardcodedPackageName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HardcodedPackageName</span><span class=p>(</span><span class=w></span>
<a id=__codelineno-17-13 name=__codelineno-17-13 href=#__codelineno-17-13></a><span class=w>        </span><span class=n>packageName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Base64</span><span class=p>.</span><span class=na>decode</span><span class=p>(</span><span class=n>base64PackageName</span><span class=p>,</span><span class=w> </span><span class=n>Base64</span><span class=p>.</span><span class=na>DEFAULT</span><span class=p>).</span><span class=na>toString</span><span class=p>(</span><span class=n>Charsets</span><span class=p>.</span><span class=na>UTF_8</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-17-14 name=__codelineno-17-14 href=#__codelineno-17-14></a><span class=w>    </span><span class=p>)</span><span class=w></span>
<a id=__codelineno-17-15 name=__codelineno-17-15 href=#__codelineno-17-15></a>
<a id=__codelineno-17-16 name=__codelineno-17-16 href=#__codelineno-17-16></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>base64ObfuscatedHardcodedSignatures</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HardcodedBase64EncodedSignature</span><span class=p>(</span><span class=w></span>
<a id=__codelineno-17-17 name=__codelineno-17-17 href=#__codelineno-17-17></a><span class=w>        </span><span class=n>Base64</span><span class=p>.</span><span class=na>decode</span><span class=p>(</span><span class=n>base64Signature</span><span class=p>,</span><span class=w> </span><span class=n>Base64</span><span class=p>.</span><span class=na>DEFAULT</span><span class=p>).</span><span class=na>toString</span><span class=p>(</span><span class=n>Charsets</span><span class=p>.</span><span class=na>UTF_8</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-17-18 name=__codelineno-17-18 href=#__codelineno-17-18></a><span class=w>    </span><span class=p>)</span><span class=w></span>
<a id=__codelineno-17-19 name=__codelineno-17-19 href=#__codelineno-17-19></a>
<a id=__codelineno-17-20 name=__codelineno-17-20 href=#__codelineno-17-20></a>
<a id=__codelineno-17-21 name=__codelineno-17-21 href=#__codelineno-17-21></a><span class=w>    </span><span class=cm>/**</span>
<a id=__codelineno-17-22 name=__codelineno-17-22 href=#__codelineno-17-22></a><span class=cm>     * Integrity package</span>
<a id=__codelineno-17-23 name=__codelineno-17-23 href=#__codelineno-17-23></a><span class=cm>     * */</span><span class=w></span>
<a id=__codelineno-17-24 name=__codelineno-17-24 href=#__codelineno-17-24></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>val</span><span class=w> </span><span class=nv>integrity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>KevlarIntegrity</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-17-25 name=__codelineno-17-25 href=#__codelineno-17-25></a><span class=w>        </span><span class=n>checks</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-17-26 name=__codelineno-17-26 href=#__codelineno-17-26></a><span class=w>            </span><span class=n>packageName</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-17-27 name=__codelineno-17-27 href=#__codelineno-17-27></a><span class=w>                </span><span class=n>hardcodedPackageName</span><span class=p>(</span><span class=n>base64ObfuscatedHardcodedPackageName</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-17-28 name=__codelineno-17-28 href=#__codelineno-17-28></a><span class=w>            </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-17-29 name=__codelineno-17-29 href=#__codelineno-17-29></a>
<a id=__codelineno-17-30 name=__codelineno-17-30 href=#__codelineno-17-30></a><span class=w>            </span><span class=n>signature</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-17-31 name=__codelineno-17-31 href=#__codelineno-17-31></a><span class=w>                </span><span class=n>hardcodedSignatures</span><span class=p>(</span><span class=n>base64ObfuscatedHardcodedSignatures</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-17-32 name=__codelineno-17-32 href=#__codelineno-17-32></a><span class=w>            </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-17-33 name=__codelineno-17-33 href=#__codelineno-17-33></a>
<a id=__codelineno-17-34 name=__codelineno-17-34 href=#__codelineno-17-34></a><span class=w>            </span><span class=n>installer</span><span class=p>()</span><span class=w></span>
<a id=__codelineno-17-35 name=__codelineno-17-35 href=#__codelineno-17-35></a><span class=w>            </span><span class=n>debug</span><span class=p>()</span><span class=w></span>
<a id=__codelineno-17-36 name=__codelineno-17-36 href=#__codelineno-17-36></a><span class=w>        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-17-37 name=__codelineno-17-37 href=#__codelineno-17-37></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-17-38 name=__codelineno-17-38 href=#__codelineno-17-38></a>
<a id=__codelineno-17-39 name=__codelineno-17-39 href=#__codelineno-17-39></a><span class=w>    </span><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=nf>attestate</span><span class=p>():</span><span class=w> </span><span class=n>IntegrityAttestation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>withContext</span><span class=p>(</span><span class=n>externalDispatcher</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-17-40 name=__codelineno-17-40 href=#__codelineno-17-40></a><span class=w>        </span><span class=n>integrity</span><span class=p>.</span><span class=na>attestate</span><span class=p>(</span><span class=n>context</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-17-41 name=__codelineno-17-41 href=#__codelineno-17-41></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-17-42 name=__codelineno-17-42 href=#__codelineno-17-42></a><span class=p>}</span><span class=w></span>
</code></pre></div> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../integrity/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Overview" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Overview </div> </div> </a> <a href=../hardcoding/ class="md-footer__link md-footer__link--next" aria-label="Next: Hardcoding" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Hardcoding </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/kevlar-kt target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://twitter.com/cioccarellia target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../../..", "features": ["content.code.annotate", "navigation.instant", "navigation.sections", "navigation.tabs", "navigation.indexes", "navigation.indexes", "search.highlight", "search.share", "search.suggest"], "search": "../../../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../../../../assets/javascripts/bundle.5a2dcb6a.min.js></script> </body> </html>